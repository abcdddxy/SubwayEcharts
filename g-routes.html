<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">  
    <title>Subway Data</title>
    <meta name="description" content="">
    <meta name="author" content="templatemo">
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,300,400italic,700' rel='stylesheet' type='text/css'>
    <link href="css/font-awesome.min.css" rel="stylesheet">
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/templatemo-style.css" rel="stylesheet">
    <script src="http://libs.baidu.com/jquery/2.0.0/jquery.min.js"></script>
    <script src="http://libs.baidu.com/bootstrap/3.0.3/js/bootstrap.min.js"></script>
    <script src="js/echarts.js"></script>
    <style>
        .templatemo-site-header{height:27px}  
    </style>
  </head>
  <body>  
    <!-- Left column -->
    <div class="templatemo-flex-row">
      <div class="templatemo-sidebar">
        <header class="templatemo-site-header">
          <i class="fa fa-subway fa-2x" aria-hidden="true" style="color:white;margin-right:20px"></i><h1 style="margin-bottom:15px">SUBWAY</h1>
        </header>
        <div class="profile-photo-container">
          <img src="images/bg.jpeg" alt="Profile Photo" class="img-responsive">  
          <div class="profile-photo-overlay"></div>
        </div>      
        <!-- Search box -->
        <form class="templatemo-search-form" role="search">
          <div class="input-group">
              <button type="submit" class="fa fa-search"></button>
              <input type="text" class="form-control" placeholder="Search" name="srch-term" id="srch-term">           
          </div>
        </form>
        <div class="mobile-menu-icon">
            <i class="fa fa-bars"></i>
        </div>
        <nav class="templatemo-left-nav">          
          <ul>
            <li><a href="guangzhou.html"><i class="fa fa-home fa-fw fa-lg"></i>主页</a></li>
            <li><a href="g-inandout.html"><i class="fa fa-area-chart fa-lg"></i>进出站客流趋势</a></li>
            <li><a href="g-stations.html"><i class="fa fa-bar-chart fa-lg"></i>进出站客流对比</a></li>
            <li><a href="g-lines.html"><i class="fa fa-line-chart fa-lg"></i>地铁线路日客流</a></li>
            <li><a href="g-startend.html"><i class="fa fa-dot-circle-o fa-lg"></i>起终点客流分析</a></li>       
            <li><a href="g-hotstation.html"><i class="fa fa-fire fa-lg"></i>热门站点及线路展示</a></li>    
            <li><a href="g-ticket.html"><i class="fa fa-pie-chart fa-lg"></i>购票方式</a></li>           
            <li><a href="g-routes.html" class="active"><i class="fa fa-street-view fa-lg"></i>乘客群体画像</a></li>
            <li><a href="index.html" target="_blank"><i class="fa fa-clock-o fa-lg" ></i>实时客流预警</a></li>
            <li><a href="mailto:somebody@qq.com"><i class="fa fa-envelope fa-lg"></i>联系我们</a></li>
          </ul>  
        </nav>
      </div>
        
      <!-- Main content --> 
      <div class="templatemo-content col-1" style="background:#2F4F4F">
        <div class="templatemo-top-nav-container">
          <div class="row">
            <nav class="templatemo-top-nav col-lg-6 col-md-12">
                  <ul class="text-uppercase">
                    <li><a href="guangzhou.html" class="active">广州</a></li>
                    <li><a href="changsha.html">长沙</a></li>
                 </ul>
            </nav>
                 <ul class="nav navbar-top-links navbar-right">
                        <a href="#"><i class="fa fa-facebook-official fa-lg" aria-hidden="true" style="margin-right:20px;color:black"></i></a>
                        <a href="#"><i class="fa fa-twitter-square fa-lg" aria-hidden="true" style="margin-right:20px;color:black"></i></a>
                        <a href="#"><i class="fa fa-wechat fa-lg" aria-hidden="true" style="margin-right:20px;color:black"></i></a>
                        <a href="#"><i class="fa fa-weibo fa-lg" aria-hidden="true" style="margin-right:20px;color:black"></i></a>
                 </ul>
          </div>
        </div>
          
        <div class="templatemo-content-container">
           <div>
            <h1 style="color:white">Subway Data</h1><br/>
            <h4 style="color:white">乘客群体画像展示<hr></h4>
           </div>  
           <div class="col-md-12" style="margin-top:5px">
               <div class="row">
                   <div class="btn-group">
                        <button class="btn btn-primary" id="users">乘客类别</button>
                        <button data-toggle="dropdown" class="btn btn-primary dropdown-toggle"><span class="caret"></span></button>
                        <ul class="dropdown-menu">
                                <li><a id="class_1">类型一</a></li>
                                <li><a id="class_2">类型二</a></li>
                                <li><a id="class_3">类型三</a></li>
                                <li><a id="class_4">类型四</a></li>
                                <li><a id="class_5">类型五</a></li>
                                <li><a id="class_6">类型六</a></li>
                                <li><a id="class_7">类型七</a></li>
                                <li><a id="class_8">类型八</a></li>
                                <li><a id="class_9">类型九</a></li>
                                <li><a id="class_10">类型十</a></li>
                        </ul>
                   </div>
                   <button class="btn btn-primary" id="submit" style="margin-left:40px">确认</button>
               </div>
               <div class="row" style="margin-top:25px">
                    <div id="allmap" style="width:100%;height:550px;margin-bottom:60px"></div>
               </div>
           </div>
        </div> 
          
          <center>
          <footer>
            <p style="color:white">Copyright &copy; 2084 Company Name 
            | Designed by <a href="http://www.templatemo.com" target="_parent">templatemo</a></p>
          </footer>         
          </center>         
        
      </div>
    </div>  
    <!-- JS -->  
    <script src="js/jquery-1.11.2.min.js"></script>      <!-- jQuery -->
    <script src="js/jquery-migrate-1.2.1.min.js"></script> <!--  jQuery Migrate Plugin -->
    <script type="text/javascript" src="js/templatemo-script.js"></script>      <!-- Templatemo Script -->
    <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=5r5Yuqvnb9NQGoiGLszs9SvMT32r1bBn"></script>
    <script type="text/javascript">  
        $(document).ready(function(){
            var routenum = null;
            var map = new BMap.Map("allmap");
            map.addControl(new BMap.NavigationControl());               // 添加平移缩放控件
            map.addControl(new BMap.ScaleControl());                    // 添加比例尺控件 
            map.addControl(new BMap.OverviewMapControl());              //添加缩略地图控件
            map.enableScrollWheelZoom();                            //启用滚轮放大缩小
            map.addControl(new BMap.MapTypeControl());          //添加地图类型控件
            map.centerAndZoom("广州", 15);
            map.disable3DBuilding();
            map.setMapStyle({style:'grayscale'});
            var bounds = null;
            var linesPoints = null;
            var spoi = [];
            var epoi = [];
            var tknum = [];
            var name = [];
            var lat = [];
            var lng = [];
            var spoi_lat = [];
            var spoi_lng = [];
            var epoi_lat = [];
            var epoi_lng = [];
            var userclass = null;
            var strs = new Array();
            var myIcon = new BMap.Icon("images/mushroom.png", new BMap.Size(32, 32),
                    {imageOffset: new BMap.Size(0, 0)});
            var myIcon2 = new BMap.Icon("images/mario.png", new BMap.Size(50, 50),
                    {imageOffset: new BMap.Size(0, 0)});
            var myIcon3 = new BMap.Icon("images/misc_mario.png", new BMap.Size(72, 72),
                    {imageOffset: new BMap.Size(0, 0)});
            function initLine() {
                bounds = new Array();
                linesPoints = new Array();
                map.clearOverlays();                                                    // 清空覆盖物
                var driving = [];
                for (var j = 0; j < routenum; j++) {
                    driving.push(new BMap.DrivingRoute(map, {onSearchComplete: drawLine}));
                    driving[j].search(new BMap.Point(spoi_lng[j], spoi_lat[j]), new BMap.Point(epoi_lng[j], epoi_lat[j]));
                }
            }
            function run() {
                //alert(linesPoints.length);
                for (var m = 0; m < linesPoints.length; m++) {
                    var pts = linesPoints[m];
                    var len = pts.length;
        //            alert(tknum[m]);
                    if (tknum[m] <= 10)
                        var carMk = new BMap.Marker(pts[0], {icon: myIcon});
                    if (tknum[m] <= 20 && tknum[m] > 10)
                        var carMk = new BMap.Marker(pts[0], {icon: myIcon2});
                    if(tknum[m] > 20)
                        var carMk = new BMap.Marker(pts[0], {icon: myIcon3});
                    map.addOverlay(carMk);
                    resetMkPoint(1, len, pts, carMk)
                }
                //alert(linesPoints.length);
                function resetMkPoint(i, len, pts, carMk) {
                    carMk.setPosition(pts[i]);
                    if (i < len) {
                        setTimeout(function () {
                            i++;
                            resetMkPoint(i, len, pts, carMk);
                        }, 20);
                    }
                }

            }
            function drawLine(results) {
                var opacity = 0.45;
                var planObj = results.getPlan(0);
                var b = new Array();
                var addMarkerFun = function (point, imgType, index, title) {
                    var url;
                    var width;
                    var height
                    var myIcon;
                    // imgType:1的场合，为起点和终点的图；2的场合为车的图形
                    if (imgType == 1) {
                        url = "http://lbsyun.baidu.com/jsdemo/img/dest_markers.png";
                        width = 42;
                        height = 34;
                        myIcon = new BMap.Icon(url, new BMap.Size(width, height),
                                {offset: new BMap.Size(14, 32), imageOffset: new BMap.Size(0, 0 - index * height)});
                    } else {
                        url = "http://lbsyun.baidu.com/jsdemo/img/trans_icons.png";
                        width = 22;
                        height = 25;
                        var d = 25;
                        var cha = 0;
                        var jia = 0;
                        if (index == 2) {
                            d = 21;
                            cha = 5;
                            jia = 1;
                        }
                        myIcon = new BMap.Icon(url, new BMap.Size(width, d),
                                {
                                    offset: new BMap.Size(10, (11 + jia)),
                                    imageOffset: new BMap.Size(0, 0 - index * height - cha)
                                });
                    }
                    var marker = new BMap.Marker(point, {icon: myIcon});
                    if (title != null && title != "") {
                        marker.setTitle(title);
                    }
                    // 起点和终点放在最上面
                    if (imgType == 1) {
                        marker.setTop(true);
                    }
                };
                var addPoints = function (points) {
                    for (var i = 0; i < points.length; i++) {
                        bounds.push(points[i]);
                        b.push(points[i]);
                    }
                };
                // 绘制驾车步行线路
                for (var i = 0; i < planObj.getNumRoutes(); i++) {
                    var route = planObj.getRoute(i);
                    if (route.getDistance(false) <= 0) {
                        continue;
                    }
                    addPoints(route.getPath());
                    // 驾车线路
                    if (route.getRouteType() == BMAP_ROUTE_TYPE_DRIVING) {
                        map.addOverlay(new BMap.Polyline(route.getPath(),
                                {strokeColor: "#0030ff", strokeOpacity: opacity, strokeWeight: 6, enableMassClear: true}));
                    } else {
                        // 步行线路有可能为0
                        map.addOverlay(new BMap.Polyline(route.getPath(),
                                {strokeColor: "#30a208", strokeOpacity: 0.75, strokeWeight: 4, enableMassClear: true}));
                    }
                }
                map.setViewport(bounds);
                // 终点
                addMarkerFun(results.getEnd().point, 1, 1);
                // 开始点
                addMarkerFun(results.getStart().point, 1, 0);
                linesPoints[linesPoints.length] = b;
            }
            $.ajax({
                type: 'GET',
                url: 'http://10.108.122.213:5000/api/get_stations',
                dataType: 'jsonp', //希望服务器返回json格式的数据
                data:{  'city' : "广州"  },
                jsonp: "callback",
                jsonpCallback: "successCallback",//回调方法
                success: function (data) {
                    //console.log(data);
                    for(var m in data.data)
                        {
                            name.push(m);
                            lat.push(data.data[m].lat);
                            lng.push(data.data[m].lng);
                        }
                }
            });
            $('a[id*="class_"]').click(function(){
                $('#users').text($(this).text()); 
                userclass = $(this).attr('id');
                strs = userclass.split("_");
                userclass = strs[strs.length-1];
            });
            $('#submit').click(function(){
                if($('#users').text()=="乘客类别")alert("请选择乘客类别");
                else{
                    spoi = [];
                    epoi = [];
                    tknum = [];
                    spoi_lat = [];
                    spoi_lng = [];
                    epoi_lat = [];
                    epoi_lng = [];
                    $.ajax({
                        type: 'GET',
                        url: 'http://10.108.122.213:5000/api/get_user_group',
                        dataType: 'jsonp', //希望服务器返回json格式的数据
                        data:{  'city' : "广州"  },
                        jsonp: "callback",
                        jsonpCallback: "successCallback",//回调方法
                        success: function (data) {
                            for(var i in data.data[userclass-1])
                                {
                                    spoi.push(data.data[userclass-1][i].stationStart);
                                    epoi.push(data.data[userclass-1][i].stationEnd);
                                    tknum.push(data.data[userclass-1][i].tk_num);
                                }
                            for(var m=0;m<spoi.length;m++)
                                {
                                    for(var n=0;n<name.length;n++)
                                        {
                                            if(spoi[m]==name[n])
                                                {
                                                    spoi_lat[m]=lat[n];
                                                    spoi_lng[m]=lng[n];
                                                }
                                            if(epoi[m]==name[n])
                                                {
                                                    epoi_lat[m]=lat[n];
                                                    epoi_lng[m]=lng[n];
                                                }
                                        }
                                }
                            //console.log(spoi);
                            routenum = tknum.length;
                            initLine();
                            setTimeout(function () {
                                run();
                            }, 3000);
                        }
                    });
                }
            });
        });
    </script>
  </body>
</html>